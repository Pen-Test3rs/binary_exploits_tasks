#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <malloc.h>
#include <unistd.h>
#include <stdint.h>

uint64_t read_num(){
    char input[32];
    memset(input, 0, sizeof(input));
    read(STDIN_FILENO, input, 0x1F);
    return strtoull(input, 0, 10);
}

void menu() {
    unsigned int idx = 0;
    char *chunks[4];
    memset(chunks, 0, 4 * sizeof(char *));

    while(1){
        printf("\nmalloc %u/%u\n", idx, 4);

        if(idx > 3){
            puts("Maximum requests reached");
            break;
        }else{
            printf("Size: ");
            uint64_t size = read_num();

            chunks[idx] = malloc(size);
            if(chunks[idx]){
                printf("Data: ");
                int max_read = malloc_usable_size(chunks[idx]);
                read(STDIN_FILENO, chunks[idx++], max_read + 8);
            }else{
                puts("malloc failed");
            }
        }
    }
}

int main(void){
    setvbuf(stdout, NULL, _IONBF, 0);
    setvbuf(stdin, NULL, _IONBF, 0);

    printf("puts @ %p\n", puts);
    char *p = malloc(0x100);
    printf("heap @ %p\n\n", p-0x10);
    free(p);

    menu();

	return 0;
}
